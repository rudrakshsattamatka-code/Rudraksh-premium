<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
        .header { background: #333; color: white; padding: 15px; text-align: center; }
        .logo { max-width: 100px; margin: 10px auto; }
        .datetime { text-align: center; font-size: 14px; margin: 5px; color: #555; }
        .section { padding: 15px; }
        .section h3 { margin-bottom: 10px; color: #333; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .card { background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; }
        .card.market { background: #2196F3; color: white; }
        .card.formula { background: #FF9800; color: white; }
        .footer { display: flex; justify-content: space-around; padding: 15px; background: white; border-top: 1px solid #ddd; }
        .footer button { padding: 10px 20px; border: none; border-radius: 4px; background: #4CAF50; color: white; font-size: 16px; cursor: pointer; }
        .footer button.logout { background: #f44336; }
    </style>
</head>
<body>
    <div class="header" id="header">
        <img id="logo" class="logo" src="" alt="Logo">
        <h2 id="headline">RUDRAKSH PREMIUM</h2>
    </div>
    <div class="datetime" id="datetime"></div>

    <div class="section">
        <h3>Markets</h3>
        <div class="grid" id="marketsGrid"></div>
    </div>

    <div class="section">
        <h3>Formulas</h3>
        <div class="grid" id="formulasGrid"></div>
    </div>

    <div class="footer">
        <button onclick="refreshPage()">Refresh</button>
        <button class="logout" onclick="logout()">Logout</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCXL6EiiLg_3lILCOSA_iFgeL8Y2nPEEnw",
            authDomain: "rudraksh-premium.firebaseapp.com",
            projectId: "rudraksh-premium",
            storageBucket: "rudraksh-premium.firebasestorage.app",
            messagingSenderId: "99880475040",
            appId: "1:99880475040:web:c64c708e9bec7fed0a6cc5"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let settings = {};
        let markets = [];
        let formulas = [];

        db.collection('siteSettings').doc('settings').onSnapshot(doc => {
            if (doc.exists) {
                settings = doc.data();
                document.getElementById('headline').innerText = settings.headline || 'RUDRAKSH PREMIUM';
                document.getElementById('logo').src = settings.logoUrl || '';
            }
        });

        db.collection('markets').onSnapshot(snapshot => {
            markets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderMarkets();
        });

        db.collection('formulas').onSnapshot(snapshot => {
            formulas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderFormulas();
        });

        function renderMarkets() {
            const container = document.getElementById('marketsGrid');
            container.innerHTML = '';
            markets.forEach(m => {
                const card = document.createElement('div');
                card.className = 'card market';
                card.innerText = m.name;
                card.onclick = () => window.location.href = `market.html?id=${m.id}`;
                container.appendChild(card);
            });
        }

        function renderFormulas() {
            const container = document.getElementById('formulasGrid');
            container.innerHTML = '';
            formulas.forEach(f => {
                const card = document.createElement('div');
                card.className = 'card formula';
                card.innerText = f.title;
                card.onclick = () => window.location.href = `formula.html?id=${f.id}`;
                container.appendChild(card);
            });
        }

        function updateDateTime() {
            const now = new Date();
            document.getElementById('datetime').innerText = now.toLocaleString('en-IN', { dateStyle: 'full', timeStyle: 'medium' });
        }
        setInterval(updateDateTime, 1000);
        updateDateTime();

        async function checkSubscription() {
            const user = auth.currentUser;
            if (!user) { window.location.href = 'login.html'; return; }
            const subDoc = await db.collection('subscriptions').doc(user.uid).get();
            if (!subDoc.exists) {
                window.location.href = 'payment.html';
                return;
            }
            const data = subDoc.data();
            if (!data.active) {
                window.location.href = 'payment.html';
                return;
            }
            const expiry = data.expiry?.toDate();
            if (expiry && expiry < new Date()) {
                await db.collection('subscriptions').doc(user.uid).update({ active: false });
                window.location.href = 'payment.html';
            }
        }

        auth.onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                checkSubscription();
            }
        });

        function refreshPage() {
            window.location.reload();
        }

        function logout() {
            auth.signOut().then(() => window.location.href = 'login.html');
        }
    </script>
</body>
</html>
